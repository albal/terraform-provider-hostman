name: Build & Release Terraform Provider

on:
  push:
    branches: [main]
    tags:
      - 'v*.*.*'    # e.g. v1.2.3

permissions:
  contents: write

jobs:
  build:
    name: 🏗 Build all platforms
    runs-on: ubuntu-latest
    # expose the parsed version for downstream jobs
    outputs:
      version: ${{ steps.set-version.outputs.version }}

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-go@v4
        with:
          go-version: '1.20'

      - uses: actions/cache@v3
        with:
          path: ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - run: go mod tidy

      - name: Determine version
        id: set-version
        run: |
          # GITHUB_REF is "refs/tags/vX.Y.Z"
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build & zip for all platforms
        run: |
          VERSION=${{ steps.set-version.outputs.version }}
          PLATFORMS=(
            "linux amd64"
            "linux arm64"
            "linux arm 6"
            "darwin amd64"
            "darwin arm64"
            "windows amd64"
          )
          mkdir dist
          for p in "${PLATFORMS[@]}"; do
            read os arch arm <<<"$p"
            export GOOS=$os
            export GOARCH=$arch
            [ "$arch" = "arm" ] && export GOARM=$arm

            BIN=terraform-provider-hostman
            [ "$os" = "windows" ] && BIN=$BIN.exe

            OUT="terraform-provider-hostman_${VERSION}_${os}_${arch}.zip"

            go build -ldflags="-s -w" -o $BIN
            zip -j dist/$OUT $BIN
            rm $BIN
          done

      - uses: actions/upload-artifact@v4
        with:
          name: provider-dist
          path: dist/*.zip

  release:
    name: 🚀 Publish GitHub Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: provider-dist
          path: dist/

      - name: Import GPG private key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          echo -e "trust\n5\ny\nquit" | \
            gpg --batch --command-fd 0 --edit-key \
              "$(gpg --list-keys --with-colons | awk -F: '/^pub/ {print $5}')"

      - name: Sign all zips
        run: |
          for z in dist/*.zip; do
            gpg --batch --yes \
                --pinentry-mode loopback \
                --passphrase "${{ secrets.GPG_PASSPHRASE }}" \
                --output "${z}.sig" \
                --detach-sign "$z"
          done

      - name: Create or update GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          allowUpdates: true
          artifacts: |
            dist/*.zip
            dist/*.zip.sig
